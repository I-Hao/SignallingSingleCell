---
title: "SignallingSingleCell"
geometry: margin=2cm
author: "Kyle Gellatly"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "")
```


```{r, include=FALSE, cache=FALSE}
library("SignallingSingleCell")
load("~/Documents/Work/Garber/Data/inDrop/mDC_UMIClean/1-RawFiles/mDC_0hr_1hr_4hr_CLEAN.Rdata")
sc_dat <- mDC_0hr_1hr_4hr_CLEAN
```

# Preprocessing

## Filtering

The first step is to filter your data to remove low quality cells. Often creating a histogram of the values and assigning cutoffs is simple and effective. Typically we remove all cells lower than 1000 UMIs / cell.

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}
dim(sc_dat)
sums_pre <- apply(sc_dat,2,sum)
range(sums_pre)
qplot(sums_pre, geom = "histogram")

filtered_data <- filter_UMIs(input = sc_dat, minUMI = 1000, maxUMI = 7500, threshold = 1, minCells = 10)

dim(filtered_data)
sums_post <- apply(filtered_data,2,sum)
range(sums_post)
qplot(sums_post, geom = "histogram")
```

## Initial Dimension reduction

Before normalization preliminary dimensionality reduction is necessary to form preliminary clusters. These clusters are used to normalize internal to a cluster before normalizing across clusters.

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}
prelim_dims <- dim_reduce(input = filtered_data, threshold = 5, minCells = 50, nComp_ICA = 10, tSNE_perp = 30, print_progress = TRUE)
```

From this we can map on our UMI counts before normalization to view if there is any bias.

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}
prelim_dims_tsne <- as.data.frame(prelim_dims[,c("x", "y")])
prelim_dims_tsne$UMIs <- sums_post
ggplot(prelim_dims_tsne) + 
  geom_point(aes(x = x, y = y, col = UMIs)) +
  scale_color_gradientn(colours=c("gray", 'blue', 'red', 'yellow')) +
  theme_classic() + 
  labs(title= "Initial Positions", x = "tSNE[1]", y = "tSNE[2]")
```

After viewing a large UMI bias we can now use spectral clustering for intial clustering before normalization. It looks as though there are about 5 clusters.

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}
prelim_dims_ICA <- as.data.frame(prelim_dims[,grep("ICA", colnames(prelim_dims))])
spec <- kknn::specClust(prelim_dims_ICA, centers = 5, method = 'random-walk')
prelim_dims_tsne$Cluster <- paste0("Cluster", spec$cluster)

ggplot(prelim_dims_tsne) + 
  geom_point(aes(x = x, y = y, col = Cluster)) +
  theme_classic() + 
  labs(title= "Initial Clusters", x = "tSNE[1]", y = "tSNE[2]")
```
